[tools]
podman = "5"


[env]
WORKDIR="/home/willians/containers/db"
MAIN="/home/willians/containers"
IMAGE="mariadb"
CONTAINER="dbase"





# === TUS SCRIPTS CONVERTIDOS ===
[tasks.build]
description = "Build MariaDB con dotfiles sincronizados (tu build.sh)"
run = """
 
    echo "Procesando en $WORKDIR/"
    podman rmi --force mariadb || true
  
    mkdir -p "$WORKDIR/dotfiles" "$MAIN/pkg" "$WORKDIR/mysql-data" "$WORKDIR/backup"
  
  # TUS rsync EXACTOS
  rsync -av ~/.bashrc "$WORKDIR/dotfiles/bashrc/"
  rsync -av ~/.ssh "$WORKDIR/dotfiles/ssh/"
  rsync -av ~/.config/starship.toml "$WORKDIR/dotfiles/config/"
  
  podman build -t mariadb -f "$WORKDIR/init/Dockerfile-root" 
  
  echo "‚úÖ mariadb: imagen  construida."
"""

[tasks.run]
description = "Ejecuta MariaDB container con vol√∫menes persistentes"
run = """

  
  podman rm dbase -f|| true
  
  echo "Ajustar permisos en mapeo mysql data"
  sudo chown -R root:root "$WORKDIR/mysql-data"
  sudo chmod -R 755 "$WORKDIR/mysql-data"
  
  podman run -d --user root:root \
    --name dbase \
    -p 3306:3306 \
   --network "$NETWORK" \
  -v "$MAIN/pkg:/root/pkg:Z" \
  -v "$WORKDIR/mysql-data:/var/lib/mysql:Z" \
  -v "$HOME/Dev/proyectos:/root/legacy:Z" \
  -v "$MAIN/Laravel/projects:/root/Laravel:Z" \
  -v "$WORKDIR/backup:/root/backup:Z" \
  -v "$WORKDIR/dotfiles/bashrc/.bashrc:/root/.bashrc:Z" \
  -v "$WORKDIR/dotfiles/ssh/.ssh:/root/.ssh:ro,Z" \
  -v "$WORKDIR/dotfiles/config:/root/.config/:Z" \
  -e "MARIADB_ROOT_PASSWORD=admin123" \
  --restart always \
  $IMAGE
    
  echo "üöÄ MariaDB en localhost:3306"
  echo "üìÅ SQL: $WORKDIR/mysql-data"
  echo "üíæ Backups: $WORKDIR/backup"
  

  
"""

[tasks.deploy]
description = "Build + Run completo (producci√≥n)"
run = "{{ tasks.build.run }} && sleep 5 && {{ tasks.run.run }}"

[tasks.stop]
description = "Detiene el contenedor MariaDB"
run = """
    podman stop $CONTAINER
    
"""

[tasks.start]
description = "Inicia contenedor MariaDB"
run = """
    podman start $CONTAINER
    echo "‚úÖ MariaDB iniciada (localhost:3306)"
"""


[tasks.exec]
description = "Entra a MariaDB (bash interactivo)"
run = """
  podman exec -it $CONTAINER bash
"""

[tasks.exec-mysql]
description = "Entra directo a MySQL/MariaDB"
run = """
  podman exec -it $CONTAINER mysql -uadmin -padmin123
"""

[tasks.restart]
description = "Reinicia MariaDB inteligentemente"
run = """
  podman restart $CONTAINER
  echo "üîÑ MariaDB reiniciada"
"""

[tasks.logs]
description = "Logs MariaDB"
run = """
    podman logs -f dbase

"""

